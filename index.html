<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MH3BXQ3P');</script>
  <!-- End Google Tag Manager -->
  
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GA4 Custom Dimensions & Metrics Manager</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MH3BXQ3P"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="container">
    <div class="app-wrapper">
      <!-- Header Section -->
      <header class="header">
        <div class="header-content">
          <h1>GA4 Custom Dimensions & Metrics Manager</h1>
          <p>Create and manage custom dimensions and metrics across multiple GA4 properties with ease</p>
        </div>
      </header>
      
      <!-- Main Content -->
      <main class="content">
        <!-- Step 1: Property Selection -->
        <section class="step">
          <h3>
            <span class="step-number">1</span>
            Select GA4 Properties
            <span class="count-indicator" style="margin-left: auto; font-size: var(--font-size-sm);">Max 3</span>
          </h3>
          
          <div class="form-group">
            <button onclick="loadProperties()" id="loadPropsBtn" class="btn-primary">
              üîó Load My GA4 Properties
            </button>
            <div id="propertyLoader" style="display: none; text-align: center; margin-top: var(--spacing-4);">
              <div class="loading"></div>
              <span style="margin-left: var(--spacing-2); color: var(--gray-600);">Loading properties...</span>
            </div>
          </div>
          
          <div class="form-group">
            <select id="propertySelect" style="display: none;" onchange="onPropertyChange()" multiple>
              <option value="">Select GA4 Properties...</option>
            </select>
            <small style="color: var(--gray-500); display: block; margin-top: var(--spacing-2);">
              üí° Hold Ctrl (Windows) or Cmd (Mac) to select multiple properties. Maximum 3 properties allowed.
            </small>
          </div>
          
          <div id="selectedPropertiesDisplay" style="display: none;"></div>
          <div id="existingDimensions" style="display: none;"></div>
          <div id="existingMetrics" style="display: none;"></div>
        </section>

        <!-- Step 2: Choose Type -->
        <section class="step">
          <h3>
            <span class="step-number">2</span>
            Choose Content Type
          </h3>
          
          <div class="main-tabs">
            <button class="main-tab active" onclick="switchMainTab(event, 'dimensions')">
               Custom Dimensions
            </button>
            <button class="main-tab" onclick="switchMainTab(event, 'metrics')">
              Custom Metrics
            </button>
          </div>

          <!-- DIMENSIONS TAB -->
          <div id="dimensions-main-tab" class="main-tab-content active">
            <div class="tabs">
              <button class="tab active" onclick="switchTab(event, 'manual')"> Manual Entry</button>
              <button class="tab" onclick="switchTab(event, 'csv')"> Unified CSV Upload</button>
            </div>

            <!-- Manual Entry for Dimensions -->
            <div id="manual-tab" class="tab-content active">
              <div class="manual-form">
                <div class="form-row">
                  <div class="form-group">
                    <label>Display Name *</label>
                    <input type="text" id="manualDisplayName" placeholder="e.g., Content Type" />
                  </div>
                  <div class="form-group">
                    <label>Parameter Name *</label>
                    <input type="text" id="manualParameterName" placeholder="e.g., content_type" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="manualDescription" placeholder="e.g., The type of content interacted with" />
                  </div>
                  <div class="form-group">
                    <label>Scope</label>
                    <select id="manualScope">
                      <option value="EVENT">Event</option>
                      <option value="USER">User</option>
                      <option value="ITEM">Item</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="button-group">
                <button onclick="addManualDimension()" class="btn-small">‚ûï Add Dimension</button>
                <button onclick="generateSample()" class="btn-secondary btn-small">üéØ Add Sample Data</button>
              </div>
            </div>

            <!-- CSV Upload for Dimensions -->
            <div id="csv-tab" class="tab-content">
              <div class="unified-csv-info">
                <h4>üìÑ Unified CSV Format</h4>
                <p>Upload one CSV file that can create both dimensions and metrics. Required columns:</p>
                <ul>
                  <li><strong>Key</strong> - Parameter name (e.g., "user_type")</li>
                  <li><strong>Name</strong> - Display name (e.g., "User Type")</li>
                  <li><strong>Notes/Description</strong> - Description text</li>
                  <li><strong>GA4 Custom Dimension</strong> - TRUE to create as dimension</li>
                  <li><strong>GA4 Custom Metric</strong> - TRUE to create as metric</li>
                  <li><strong>Measurement Unit</strong> - Unit of measurement</li>
                </ul>
              </div>
              <div class="file-drop" onclick="document.getElementById('csvFile').click()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)">
                <p><strong>üìé Click to upload or drag & drop your unified CSV file</strong></p>
                <p>The CSV can contain both dimensions and metrics in one file</p>
              </div>
              <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event, 'csv')" />
              <div class="button-group">
                <button onclick="downloadTemplate('csv')" class="btn-secondary btn-small">‚¨áÔ∏è Download Unified CSV Template</button>
              </div>
            </div>

            <!-- Review Dimensions -->
            <div class="step" style="margin-top: var(--spacing-6);">
              <h3>
                <span class="step-number">3</span>
                Review Dimensions
                <span class="count-indicator" id="dimensionCount">0</span>
              </h3>
              <div id="dimensionList" class="dimension-list">
                <div class="empty-state">
                  <p>üìä No dimensions added yet. Use the input methods above to add some.</p>
                </div>
              </div>
              <div class="button-group">
                <button onclick="validateAllDimensions()" class="btn-secondary btn-small">‚úÖ Validate All</button>
                <button onclick="clearAllDimensions()" class="btn-secondary btn-small">üóëÔ∏è Clear All</button>
              </div>
            </div>
          </div>

          <!-- METRICS TAB -->
          <div id="metrics-main-tab" class="main-tab-content">
            <div class="tabs">
              <button class="tab active" onclick="switchTab(event, 'metric-manual')"> Manual Entry</button>
              <button class="tab" onclick="switchTab(event, 'metric-csv')"> Unified CSV Upload</button>
            </div>

            <!-- Manual Entry for Metrics -->
            <div id="metric-manual-tab" class="tab-content active">
              <div class="manual-form">
                <div class="form-row">
                  <div class="form-group">
                    <label>Display Name *</label>
                    <input type="text" id="metricManualDisplayName" placeholder="e.g., Revenue Per User" />
                  </div>
                  <div class="form-group">
                    <label>Parameter Name *</label>
                    <input type="text" id="metricManualParameterName" placeholder="e.g., revenue_per_user" />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="metricManualDescription" placeholder="e.g., Revenue generated per individual user" />
                  </div>
                  <div class="form-group">
                    <label>Measurement Unit</label>
                    <select id="metricManualUnit">
                      <option value="STANDARD">Standard</option>
                      <option value="CURRENCY">Currency</option>
                      <option value="FEET">Feet</option>
                      <option value="METERS">Meters</option>
                      <option value="KILOMETERS">Kilometers</option>
                      <option value="MILES">Miles</option>
                      <option value="MILLISECONDS">Milliseconds</option>
                      <option value="SECONDS">Seconds</option>
                      <option value="MINUTES">Minutes</option>
                      <option value="HOURS">Hours</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="button-group">
                <button onclick="addManualMetric()" class="btn-small">‚ûï Add Metric</button>
                <button onclick="generateSample()" class="btn-secondary btn-small">üéØ Add Sample Data</button>
              </div>
            </div>

            <!-- CSV Upload for Metrics -->
            <div id="metric-csv-tab" class="tab-content">
              <div class="unified-csv-info">
                <h4>üìÑ Unified CSV Format</h4>
                <p>Upload one CSV file that can create both dimensions and metrics. Required columns:</p>
                <ul>
                  <li><strong>Key</strong> - Parameter name (e.g., "revenue_per_user")</li>
                  <li><strong>Name</strong> - Display name (e.g., "Revenue Per User")</li>
                  <li><strong>Notes/Description</strong> - Description text</li>
                  <li><strong>GA4 Custom Dimension</strong> - TRUE to create as dimension</li>
                  <li><strong>GA4 Custom Metric</strong> - TRUE to create as metric</li>
                  <li><strong>Measurement Unit</strong> - Unit of measurement</li>
                </ul>
              </div>
              <div class="file-drop" onclick="document.getElementById('metricCsvFile').click()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)">
                <p><strong>üìé Click to upload or drag & drop your unified CSV file</strong></p>
                <p>The CSV can contain both dimensions and metrics in one file</p>
              </div>
              <input type="file" id="metricCsvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event, 'csv')" />
              <div class="button-group">
                <button onclick="downloadTemplate('csv')" class="btn-secondary btn-small">‚¨áÔ∏è Download Unified CSV Template</button>
              </div>
            </div>

            <!-- Review Metrics -->
            <div class="step" style="margin-top: var(--spacing-6);">
              <h3>
                <span class="step-number">3</span>
                Review Metrics
                <span class="count-indicator" id="metricCount">0</span>
              </h3>
              <div id="metricList" class="metric-list">
                <div class="empty-state">
                  <p>üìà No metrics added yet. Use the input methods above to add some.</p>
                </div>
              </div>
              <div class="button-group">
                <button onclick="validateAllMetrics()" class="btn-secondary btn-small">‚úÖ Validate All</button>
                <button onclick="clearAllMetrics()" class="btn-secondary btn-small">üóëÔ∏è Clear All</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Step 4: Options -->
        <section class="step">
          <h3>
            <span class="step-number">4</span>
            Configuration Options
          </h3>
          <div class="form-row">
            <div class="form-group">
              <label>
                <input type="checkbox" id="checkDuplicates" checked />
                üîç Check for duplicates before creating
              </label>
            </div>
            <div class="form-group">
              <label>Batch Size (items per request)</label>
              <input type="number" id="batchSize" value="10" min="1" max="50" />
            </div>
            <div class="form-group">
              <label>Delay Between Batches (milliseconds)</label>
              <input type="number" id="delay" value="1000" min="100" max="5000" />
            </div>
          </div>
        </section>

        <!-- Step 5: Create Button -->
        <section class="step">
          <h3>
            <span class="step-number">5</span>
            <span id="createSectionTitle">Create Custom Dimensions</span>
          </h3>
          <button id="createBtn" onclick="createAllDimensions()" disabled>
            Create Custom Dimensions
          </button>
          <div id="processLoader" style="display: none; text-align: center; margin-top: var(--spacing-4);">
            <div class="loading"></div>
            <span id="processText" style="margin-left: var(--spacing-2); color: var(--gray-600);">Creating custom dimensions...</span>
          </div>
        </section>

        <!-- Results Section -->
        <div id="results" style="display: none;"></div>
      </main>
    </div>
  </div>

  <!-- Load Google APIs and custom script -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script>
    // Enhanced logging system
    const Logger = {
      prefix: '[GA4 Manager]',
      
      log: function(message, data = null) {
        const timestamp = new Date().toISOString();
        console.log(`${this.prefix} [${timestamp}] ${message}`, data || '');
      },
      
      error: function(message, error = null) {
        const timestamp = new Date().toISOString();
        console.error(`${this.prefix} [${timestamp}] ERROR: ${message}`, error || '');
      },
      
      warn: function(message, data = null) {
        const timestamp = new Date().toISOString();
        console.warn(`${this.prefix} [${timestamp}] WARNING: ${message}`, data || '');
      },
      
      group: function(title) {
        console.group(`${this.prefix} ${title}`);
      },
      
      groupEnd: function() {
        console.groupEnd();
      },
      
      table: function(data) {
        console.table(data);
      }
    };

    // Enhanced GA4Manager class with comprehensive logging
    class GA4Manager {
      constructor() {
        Logger.group('GA4Manager Constructor');
        Logger.log('Initializing GA4Manager...');
        
        this.accessToken = null;
        this.isAuthenticated = false;
        this.tokenClient = null;
        this.authStartTime = null;
        
        Logger.log('Properties initialized', {
          accessToken: this.accessToken,
          isAuthenticated: this.isAuthenticated,
          tokenClient: this.tokenClient
        });
        
        this.init();
        Logger.log('GA4Manager constructor completed successfully');
        Logger.groupEnd();
      }

      init() {
        Logger.group('GA4Manager Initialization');
        Logger.log('Starting GAPI and Google Accounts initialization...');
        
        try {
          // Initialize GAPI
          Logger.log('Loading GAPI client...');
          gapi.load('client', () => {
            Logger.log('GAPI client loaded successfully');
            
            gapi.client.init({
              apiKey: '', 
              discoveryDocs: ['https://analyticsadmin.googleapis.com/$discovery/rest?version=v1beta']
            }).then(() => {
              Logger.log('GAPI client initialized successfully');
            }).catch(error => {
              Logger.error('GAPI client initialization failed', error);
            });
          });

          // Initialize Google Accounts
          Logger.log('Initializing Google Accounts ID...');
          google.accounts.id.initialize({
            client_id: '903553466558-ggf600mr9qauuimpfmc0olc94dledr2n.apps.googleusercontent.com'
          });
          Logger.log('Google Accounts ID initialized successfully');

          // Initialize OAuth Token Client
          Logger.log('Initializing OAuth token client...');
          this.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: '903553466558-ggf600mr9qauuimpfmc0olc94dledr2n.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/analytics.edit',
            callback: (response) => {
              Logger.group('OAuth Callback');
              Logger.log('OAuth callback received', response);
              
              if (response.error !== undefined) {
                Logger.error('OAuth callback error', response.error);
                throw new Error(response.error);
              }
              
              this.handleAuthSuccess(response);
              Logger.groupEnd();
            },
          });
          
          Logger.log('Token client initialized successfully');
          
        } catch (error) {
          Logger.error('Initialization failed', error);
          throw error;
        }
        
        Logger.groupEnd();
      }

      async authenticate() {
        Logger.group('Authentication Process');
        Logger.log('Starting authentication flow...');
        
        try {
          this.authStartTime = Date.now();
          Logger.log('Auth start time recorded', new Date(this.authStartTime));
          
          this.tokenClient.requestAccessToken({prompt: 'consent'});
          Logger.log('Access token request initiated');
          
        } catch (error) {
          Logger.error('Authentication failed', error);
          throw new Error('Authentication failed: ' + error.message);
        } finally {
          Logger.groupEnd();
        }
      }

      handleAuthSuccess(response) {
        Logger.group('Authentication Success Handler');
        const authDuration = Date.now() - this.authStartTime;
        
        Logger.log('Authentication completed successfully', {
          duration: `${authDuration}ms`,
          response: response
        });
        
        this.isAuthenticated = true;
        this.accessToken = response.access_token;
        
        Logger.log('Authentication state updated', {
          isAuthenticated: this.isAuthenticated,
          tokenLength: this.accessToken?.length,
          tokenPreview: this.accessToken?.substring(0, 20) + '...'
        });
        
        // Update UI
        const authBtn = document.getElementById('loadPropsBtn');
        if (authBtn && authBtn.textContent.includes('Load My GA4 Properties')) {
          authBtn.textContent = '‚úÖ Authenticated - Click to Load Properties';
          authBtn.style.background = 'linear-gradient(135deg, var(--success-color) 0%, #047857 100%)';
          Logger.log('UI updated to show authenticated state');
        }
        
        Logger.groupEnd();
      }

      async makeApiCall(url, options = {}) {
        Logger.group(`API Call: ${url.split('/').pop()}`);
        Logger.log('Making API call', {
          url: url,
          options: options,
          hasToken: !!this.accessToken
        });
        
        if (!this.accessToken) {
          Logger.warn('No access token available, triggering authentication');
          await this.authenticate();
          return;
        }

        const defaultOptions = {
          headers: {
            'Authorization': `Bearer ${this.accessToken}`,
            'Content-Type': 'application/json'
          }
        };

        try {
          const finalOptions = { ...defaultOptions, ...options };
          Logger.log('Final request options prepared', finalOptions);
          
          const startTime = Date.now();
          const response = await fetch(url, finalOptions);
          const duration = Date.now() - startTime;
          
          Logger.log('API response received', {
            status: response.status,
            statusText: response.statusText,
            duration: `${duration}ms`,
            headers: Object.fromEntries(response.headers.entries())
          });
          
          if (!response.ok) {
            if (response.status === 401) {
              Logger.warn('Authentication expired, clearing token');
              this.accessToken = null;
              this.isAuthenticated = false;
              throw new Error('Authentication expired. Please try again.');
            }
            
            const errorText = await response.text();
            Logger.error('API call failed', {
              status: response.status,
              statusText: response.statusText,
              errorText: errorText
            });
            throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
          }
          
          const result = await response.json();
          Logger.log('API call successful', {
            resultKeys: Object.keys(result),
            dataSize: JSON.stringify(result).length
          });
          
          Logger.groupEnd();
          return result;
          
        } catch (error) {
          Logger.error('API call failed', error);
          Logger.groupEnd();
          throw error;
        }
      }
    }

    // Global variables with enhanced logging
    let selectedPropertyIds = []; 
    let dimensions = [];
    let metrics = [];
    let existingDimensions = [];
    let existingMetrics = [];
    let currentTab = 'dimensions';

    Logger.log('Global variables initialized', {
      selectedPropertyIds: selectedPropertyIds.length,
      dimensions: dimensions.length,
      metrics: metrics.length,
      currentTab: currentTab
    });

    // Initialize GA4Manager
    const ga4Manager = new GA4Manager();

    // Enhanced UI functions with logging
    function switchMainTab(event, tabName) {
      Logger.group(`Main Tab Switch: ${tabName}`);
      Logger.log('Switching main tab', {
        from: currentTab,
        to: tabName,
        event: event.target.textContent
      });
      
      document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.main-tab-content').forEach(content => content.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(tabName + '-main-tab').classList.add('active');

      currentTab = tabName;
      Logger.log('Main tab switched successfully', { currentTab: currentTab });
      
      updateCreateButton();
      Logger.groupEnd();
    }

    function switchTab(event, tabName) {
      Logger.log('Switching sub-tab', {
        tabName: tabName,
        currentMainTab: currentTab
      });
      
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
      
      Logger.log('Sub-tab switched successfully', { activeTab: tabName });
    }

    // Enhanced logging initialization
    Logger.log('Enhanced GA4 Manager application loaded successfully');
    Logger.log('Application features initialized', {
      multiPropertySupport: true,
      maxProperties: 3,
      unifiedCSVFormat: true,
      batchProcessing: true,
      duplicateDetection: true,
      comprehensiveLogging: true
    });

    Logger.log('UI enhancement completed', {
      modernDesign: true,
      responsiveLayout: true,
      accessibilityImproved: true,
      userFriendlyInterface: true
    });

    // Load the original JavaScript file
    const script = document.createElement('script');
    script.src = 'ga4-manager.js';
    script.onload = function() {
      Logger.log('Original GA4 Manager script loaded successfully');
    };
    script.onerror = function() {
      Logger.error('Failed to load original GA4 Manager script');
    };
    document.head.appendChild(script);
  </script>
</body>
</html>